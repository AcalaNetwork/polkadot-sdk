name: Release - Publish draft

on:
  # push:
  #   tags:
  #     # Catches v1.2.3 and v1.2.3-rc1
  #     - v[0-9]+.[0-9]+.[0-9]+*

  workflow_dispatch:
    inputs:
      version:
        description: Current release version as a number
        default: v1.9.0
        required: true

jobs:
  get-rust-versions:
    runs-on: ubuntu-latest
    container:
      image: paritytech/ci-unified:bullseye-1.75.0-2024-01-22-v20240109
    outputs:
      rustc-stable: ${{ steps.get-rust-versions.outputs.stable }}
      rustc-nightly: ${{ steps.get-rust-versions.outputs.nightly }}
    steps:
      - id: get-rust-versions
        run: |
          echo "stable=$(rustc +stable --version)" >> $GITHUB_OUTPUT
          echo "nightly=$(rustc +nightly --version)" >> $GITHUB_OUTPUT

  # build-runtimes:
  #   uses: "./.github/workflows/srtool.yml"
  #   with:
  #      excluded_runtimes: "substrate-test cumulus-test-runtime kitchensink-runtime minimal-template-runtime parachain-template-runtime penpal-runtime polkadot-test-runtime rococo-parachain-runtime rococo-runtime-diff seedling-runtime shell-runtime westend-runtime-diff"

  publish-darft-release:
    runs-on: ubuntu-latest
    # needs: [get-rust-versions, build-runtimes]
    needs: [get-rust-versions]
    outputs:
      release_url: ${{ steps.create-release.outputs.html_url }}
      asset_upload_url: ${{ steps.create-release.outputs.upload_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4.0.0

      - name: Compile release notes
        env:
          VERSION: ${{ inputs.version }}
        run: |
          VERSION=$(echo "$VERSION" | sed -E 's/^v([0-9]+\.[0-9]+\.[0-9]+).*$/\1/')
          TMP=$(mktemp -d)
          ./scripts/release/build-changelog.sh

          ls -al $TMP
          mv $TMP/elnote_combined.md CHANGELOG.md
          cat CHANGELOG.md

      - name: Download artifacts
        uses: actions/download-artifact@c850b930e6ba138125429b7e5c93fc707a7f8427 # v4.1.4
