name: "Zombienet test v1"
inputs:
  test:
    description: "test definition (zndsl file)"
    required: true
  local-dir:
    description: "Path to the directory tha contains the test file (.zndsl)"
    required: true
  concurrency:
    description: "Concurrency to spawn nodes"
    default: 4
    required: false

runs:
  using: "composite"
  steps:
    - name: common_vars
      shell: bash
      env:
        TEST_NAME: ${{ inputs.test }}
        LOCAL_PATH: ${{ inputs.local-dir }}
        CONCURRENCY: ${{ inputs.concurrency }}
      run: |
        echo "Vars"
        echo "ZOMBIENET_INTEGRATION_TEST_IMAGE: $ZOMBIENET_INTEGRATION_TEST_IMAGE"
        echo "COL_IMAGE: $COL_IMAGE"
        echo "Inputs"
        echo "test: $TEST_NAME"
        echo "local-dir: $LOCAL_PATH"
        echo "concurrency: $CONCURRENCY"

    - uses: ./.github/actions/download-artifact-extract
      with:
        artifact-name: build-linux-stable-${{ inputs.ref-slug }}
        gh-token: ${{ inputs.gh-token }}
        run-id: ${{ inputs.build-id }}
        extract-path: ./tmp
        files-to-copy: |
          artifacts/polkadot
          artifacts/polkadot-execute-worker
          artifacts/polkadot-prepare-worker
        destination-path: ./bin
        cleanup: "true"


    - uses: ./.github/actions/download-artifact-extract
      with:
        artifact-name: build-linux-stable-cumulus-${{ inputs.ref-slug }}
        gh-token: ${{ inputs.gh-token }}
        run-id: ${{ inputs.build-id }}
        extract-path: ./tmp
        files-to-copy: |
          artifacts/polkadot-parachain
        destination-path: ./bin
        cleanup: "true"

    - uses: ./.github/actions/download-artifact-extract
      with:
        artifact-name: build-test-parachain-${{ inputs.ref-slug }}
        gh-token: ${{ inputs.gh-token }}
        run-id: ${{ inputs.build-id }}
        extract-path: ./tmp
        files-to-copy: |
          artifacts/test-parachain
        destination-path: ./bin
        cleanup: "true"

    - uses: ./.github/actions/download-artifact-extract
      with:
        artifact-name: build-test-collators-${{ inputs.ref-slug }}
        gh-token: ${{ inputs.gh-token }}
        run-id: ${{ inputs.build-id }}
        extract-path: ./tmp
        files-to-copy: |
          artifacts/adder-collator
          artifacts/undying-collator
        destination-path: ./bin
        cleanup: "true"

    - uses: ./.github/actions/download-artifact-extract
      with:
        artifact-name: build-malus-${{ inputs.ref-slug }}
        gh-token: ${{ inputs.gh-token }}
        run-id: ${{ inputs.build-id }}
        extract-path: ./tmp
        # TODO: should copy polkadot-execute-worker and polkadot-prepare-worker?
        # if yes then it overlaps with build-linux-stable - address this
        files-to-copy: |
          artifacts/malus
        destination-path: ./bin
        cleanup: "true"

    - uses: ./.github/actions/download-artifact-extract
      with:
        artifact-name: build-templates-node-${{ inputs.ref-slug }}
        gh-token: ${{ inputs.gh-token }}
        run-id: ${{ inputs.build-id }}
        extract-path: ./tmp
        files-to-copy: |
          artifacts/minimal-template-node
          artifacts/parachain-template-node
          artifacts/solochain-template-node
        destination-path: ./bin
        cleanup: "true"

    - name: zombie_test
      shell: bash
      env:
        TEST_NAME: ${{ inputs.test }}
        LOCAL_PATH: ${{ inputs.local-dir }}
        CONCURRENCY: ${{ inputs.concurrency }}
      run: |
        export PATH=$(pwd)/bin:$PATH
        chmod +x $(pwd)/bin/*

        if [[ $ZOMBIENET_RUNNER == "parity-zombienet" ]]; then
          export ZOMBIE_NAMESPACE=$(cat /data/namespace)
        fi;
        ./.github/scripts/run-zombienet-test.sh \
          "$(pwd)/$LOCAL_PATH" \
          $CONCURRENCY \
          "$TEST_NAME"

    - name: upload_logs
      uses: actions/upload-artifact@v4
      if: ${{ ! cancelled() }}
      with:
        name: zombienet-logs-${{ github.job }}-${{ github.sha }}
        path: |
          /tmp/zombie*/logs/*

